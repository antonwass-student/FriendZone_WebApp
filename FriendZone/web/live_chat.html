<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat</title>

    <script src="bower_components/angular/angular.js"></script>

</head>

<body>
    <div ng-app="myApp" ng-controller="chatWindow">
        <div>
            <form id="chat">
                <button type="submit" value="{{connectTo}}"></button>
                <div ng-repeat="chat in conversations">
                    <fieldset>
                        <legend>{{chat.name}} - id: {{chat.id}}</legend>
                        <table>
                            <tr id="msg" ng-repeat="message in chat.messages">
                                <td>from: {{message.sender}}</td>
                                <td>{{message.message}}</td>
                                <br />
                            </tr>
                        </table>
                    </fieldset>
                </div>

                <fieldset>
                    <legend>Enter message...</legend>
                    <div>
                        <input type="text" placeholder="Your message..." id="inField"/>
                        <input type="submit" value="Send!" />
                    </div>
                </fieldset>
            </form>

        </div>
    </div>
</body>

<script type="text/javascript">

    var app = angular.module('myApp', []);

    app.controller('chatWindow', function($scope){
        $scope.websocket = null;
        $scope.userId = null
        $scope.friends = [];
        $scope.conversations = []

        $scope.connectTo = function(socket) {
            websocket = new WebSocket("ws://127.0.0.1:8090/");
            websocket.onopen = $scope.onConnect
            websocket.onmessage = $scope.onMessage
            console.log("connected!");
        }

        $scope.onConnect = function (event) {
            $scope.getConversations()
            $scope.getFriends()
        }
        
        $scope.send = function (message) {
            var jsonMsg = {
                type: "message",
                id: "1",
                message: message,
                sender:$scope.userId
            };
            $scope.websocket.send(JSON.stringify(jsonMsg))
        }
        
        $scope.onMessage = function (evt) {
            var msg = JSON.parse(evt.data);
            console.log(msg.type);
            switch (msg.type) {
                case 'openConversation':
                    console.log('type = openConversation');
                    // Append message to correct conversation.
                case 'message':
                    var newMessage = $('<td>'+msg.sender+':</td><td>'+msg.message+'</td><br />')
                    $('#msg').appendChild(newMessage)
                case 'conversation':
                    console.log('type = conversation')
                    $scope.conversations = msg.conversations;
                case 'friends':
                    console.log('type = friends')
                    $scope.friends = msg.friends;
                default:
                    console.log("default... we don't know how to handle this...")
            }
        }

        $scope.getFriends = function () {
            var jsonMsg = {type:'friends',id:$scope.userId}
            $scope.websocket.send(JSON.stringify(jsonMsg));
        }

        $scope.getConversations = function () {
            var jsonMsg = {type: 'conversation', id: $scope.userId}
            $scope.websocket.send(JSON.stringify(jsonMsg));
        }

        $scope.getMessagesFrom = function (conversationId) {
            var jsonMsg = {
                type: 'openConversation',
                id: conversationId
            }
            $scope.websocket.send(JSON.stringify(jsonMsg));
        }

        $scope.createConversation = function (who) {
            var jsonMsg = {
                type: 'new',
                name: 'Chatnamn!',
                sender: $scope.userId,
                invited: who
            }
            $scope.websocket.send(JSON.stringify(jsonMsg));
        }

        $scope.inviteToConversation = function (convId,who) {
            var jsonMsg = {
                type: 'invited',
                convId: convId,
                sender: $scope.userId,
                who: who
            }
            $scope.websocket.send(JSON.stringify(jsonMsg));
        }

        // On ready
        angular.element(document).ready(function () {
            $scope.userId = 'SÃ¤tt id!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!'
        });


    });

</script>

</html>